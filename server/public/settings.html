<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Silo Monitor</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .settings-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 24px;
        }

        .settings-header {
            margin-bottom: 32px;
        }

        .settings-header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 8px;
        }

        .settings-header p {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .section-header {
            padding: 16px 20px;
            background: #0f172a;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .section-header:hover {
            background: #1a2332;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f1f5f9;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-icon {
            font-size: 1.2rem;
        }

        .section-toggle {
            font-size: 1.2rem;
            color: #64748b;
            transition: transform 0.2s;
        }

        .section.collapsed .section-toggle {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 20px;
            display: grid;
            gap: 16px;
        }

        .section.collapsed .section-content {
            display: none;
        }

        .form-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            align-items: center;
        }

        .form-group label {
            font-size: 0.9rem;
            color: #cbd5e1;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 10px 12px;
            color: #f1f5f9;
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group input:invalid {
            border-color: #ef4444;
        }

        .form-group .input-hint {
            grid-column: 2;
            font-size: 0.75rem;
            color: #64748b;
            margin-top: -8px;
        }

        .subsection {
            background: #0f172a;
            padding: 16px;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
        }

        .subsection-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 20px;
            background: #0f172a;
            border-top: 1px solid #334155;
            position: sticky;
            bottom: 0;
            z-index: 50;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            max-width: 400px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            background: #10b981;
            color: white;
        }

        .notification.error {
            background: #ef4444;
            color: white;
        }

        .notification.info {
            background: #3b82f6;
            color: white;
        }

        .notification.warning {
            background: #f59e0b;
            color: white;
        }

        .changed {
            animation: highlight 0.5s ease-out;
        }

        @keyframes highlight {
            0% {
                background: rgba(59, 130, 246, 0.3);
            }

            100% {
                background: transparent;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #334155;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @media (max-width: 768px) {
            .form-group {
                grid-template-columns: 1fr;
            }

            .form-group .input-hint {
                grid-column: 1;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div class="topbar">
        <div class="topbar-left">
            <h1>‚öôÔ∏è System Configuration</h1>
        </div>
        <div class="topbar-right">
            <span>Last synced: <span id="lastSynced">-</span></span>
            <button class="refresh-btn" onclick="window.location.href='/'">
                ‚Üê Dashboard
            </button>
        </div>
    </div>

    <div class="settings-container">
        <div class="settings-header">
            <h1>Configuration Settings</h1>
            <p>Configure all system parameters. Changes are saved to config.json and applied in real-time.</p>
        </div>

        <form id="configForm">
            <!-- Thresholds Section -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">
                        <span class="section-icon">üìä</span>
                        Thresholds
                    </div>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-content">
                    <!-- Temperature -->
                    <div class="subsection">
                        <div class="subsection-title">Temperature (¬∞C)</div>
                        <div class="form-group">
                            <label>Ideal Min</label>
                            <input type="number" step="0.1" name="thresholds.temperature.idealMin" required>
                        </div>
                        <div class="form-group">
                            <label>Ideal Max</label>
                            <input type="number" step="0.1" name="thresholds.temperature.idealMax" required>
                        </div>
                        <div class="form-group">
                            <label>Warning Min</label>
                            <input type="number" step="0.1" name="thresholds.temperature.warningMin" required>
                        </div>
                        <div class="form-group">
                            <label>Warning Max</label>
                            <input type="number" step="0.1" name="thresholds.temperature.warningMax" required>
                        </div>
                        <div class="form-group">
                            <label>Critical Min</label>
                            <input type="number" step="0.1" name="thresholds.temperature.criticalMin" required>
                        </div>
                        <div class="form-group">
                            <label>Critical Max</label>
                            <input type="number" step="0.1" name="thresholds.temperature.criticalMax" required>
                        </div>
                    </div>

                    <!-- Humidity -->
                    <div class="subsection">
                        <div class="subsection-title">Humidity (%)</div>
                        <div class="form-group">
                            <label>Ideal Min</label>
                            <input type="number" step="0.1" min="0" max="100" name="thresholds.humidity.idealMin"
                                required>
                        </div>
                        <div class="form-group">
                            <label>Ideal Max</label>
                            <input type="number" step="0.1" min="0" max="100" name="thresholds.humidity.idealMax"
                                required>
                        </div>
                        <div class="form-group">
                            <label>Warning Min</label>
                            <input type="number" step="0.1" min="0" max="100" name="thresholds.humidity.warningMin"
                                required>
                        </div>
                        <div class="form-group">
                            <label>Warning Max</label>
                            <input type="number" step="0.1" min="0" max="100" name="thresholds.humidity.warningMax"
                                required>
                        </div>
                        <div class="form-group">
                            <label>Critical Min</label>
                            <input type="number" step="0.1" min="0" max="100" name="thresholds.humidity.criticalMin"
                                required>
                        </div>
                        <div class="form-group">
                            <label>Critical Max</label>
                            <input type="number" step="0.1" min="0" max="100" name="thresholds.humidity.criticalMax"
                                required>
                        </div>
                    </div>

                    <!-- Air Quality -->
                    <div class="subsection">
                        <div class="subsection-title">Air Quality (MQ135)</div>
                        <div class="form-group">
                            <label>Good Threshold</label>
                            <input type="number" step="1" min="0" name="thresholds.airQuality.good" required>
                        </div>
                        <div class="form-group">
                            <label>Moderate Threshold</label>
                            <input type="number" step="1" min="0" name="thresholds.airQuality.moderate" required>
                        </div>
                        <div class="form-group">
                            <label>Poor Threshold</label>
                            <input type="number" step="1" min="0" name="thresholds.airQuality.poor" required>
                        </div>
                        <div class="form-group">
                            <label>Very Poor Threshold</label>
                            <input type="number" step="1" min="0" name="thresholds.airQuality.veryPoor" required>
                        </div>
                    </div>

                    <!-- Spoilage Risk -->
                    <div class="subsection">
                        <div class="subsection-title">Spoilage Risk (%)</div>
                        <div class="form-group">
                            <label>Low Threshold</label>
                            <input type="number" step="1" min="0" max="100" name="thresholds.spoilageRisk.low" required>
                        </div>
                        <div class="form-group">
                            <label>Medium Threshold</label>
                            <input type="number" step="1" min="0" max="100" name="thresholds.spoilageRisk.medium"
                                required>
                        </div>
                        <div class="form-group">
                            <label>High Threshold</label>
                            <input type="number" step="1" min="0" max="100" name="thresholds.spoilageRisk.high"
                                required>
                        </div>
                        <div class="form-group">
                            <label>Critical Threshold</label>
                            <input type="number" step="1" min="0" max="100" name="thresholds.spoilageRisk.critical"
                                required>
                        </div>
                    </div>

                    <!-- Condensation -->
                    <div class="subsection">
                        <div class="subsection-title">Condensation</div>
                        <div class="form-group">
                            <label>Dew Point Difference (¬∞C)</label>
                            <input type="number" step="0.1" min="0" name="thresholds.condensation.dewPointDifference"
                                required>
                            <span class="input-hint">Temperature-dew point difference threshold</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alerts Section -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">
                        <span class="section-icon">üîî</span>
                        Alerts
                    </div>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label>Buzzer Enabled</label>
                        <select name="alerts.buzzerEnabled">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Buzzer Duration (ms)</label>
                        <input type="number" step="100" min="100" name="alerts.buzzerDuration" required>
                    </div>
                    <div class="form-group">
                        <label>Critical Risk Threshold (%)</label>
                        <input type="number" step="1" min="0" max="100" name="alerts.criticalRiskThreshold" required>
                    </div>
                    <div class="form-group">
                        <label>Mute After Acknowledge</label>
                        <select name="alerts.muteAfterAcknowledge">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sound Pattern</label>
                        <select name="alerts.soundPattern">
                            <option value="continuous">Continuous</option>
                            <option value="pulsing">Pulsing</option>
                            <option value="beeping">Beeping</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Data Collection Section -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">
                        <span class="section-icon">üíæ</span>
                        Data Collection
                    </div>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label>Sample Interval (ms)</label>
                        <input type="number" step="1000" min="1000" name="dataCollection.sampleInterval" required>
                        <span class="input-hint">How often sensors collect data</span>
                    </div>
                    <div class="form-group">
                        <label>Auto Refresh Interval (ms)</label>
                        <input type="number" step="1000" min="1000" name="dataCollection.autoRefreshInterval" required>
                        <span class="input-hint">Dashboard refresh rate</span>
                    </div>
                    <div class="form-group">
                        <label>Data Retention (days)</label>
                        <input type="number" step="1" min="1" name="dataCollection.dataRetentionDays" required>
                        <span class="input-hint">How long to keep historical data</span>
                    </div>
                    <div class="form-group">
                        <label>History Size</label>
                        <input type="number" step="1" min="1" name="dataCollection.historySize" required>
                        <span class="input-hint">Number of data points for trend analysis</span>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div class="section collapsed">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">
                        <span class="section-icon">üìà</span>
                        Analytics
                    </div>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-content">
                    <!-- Trend Detection -->
                    <div class="subsection">
                        <div class="subsection-title">Trend Detection</div>
                        <div class="form-group">
                            <label>Rising Rapidly Threshold</label>
                            <input type="number" step="0.1" name="analytics.trendDetection.risingRapidlyThreshold"
                                required>
                        </div>
                        <div class="form-group">
                            <label>Rising Threshold</label>
                            <input type="number" step="0.1" name="analytics.trendDetection.risingThreshold" required>
                        </div>
                        <div class="form-group">
                            <label>Falling Rapidly Threshold</label>
                            <input type="number" step="0.1" name="analytics.trendDetection.fallingRapidlyThreshold"
                                required>
                        </div>
                        <div class="form-group">
                            <label>Falling Threshold</label>
                            <input type="number" step="0.1" name="analytics.trendDetection.fallingThreshold" required>
                        </div>
                        <div class="form-group">
                            <label>Minimum Data Points</label>
                            <input type="number" step="1" min="1" name="analytics.trendDetection.minimumDataPoints"
                                required>
                        </div>
                    </div>

                    <!-- Predictions -->
                    <div class="subsection">
                        <div class="subsection-title">Predictions</div>
                        <div class="form-group">
                            <label>Minimum Data Points</label>
                            <input type="number" step="1" min="1" name="analytics.predictions.minimumDataPoints"
                                required>
                        </div>
                        <div class="form-group">
                            <label>High Confidence Threshold (%)</label>
                            <input type="number" step="1" min="0" max="100"
                                name="analytics.predictions.confidenceThresholds.high" required>
                        </div>
                        <div class="form-group">
                            <label>Medium Confidence Threshold (%)</label>
                            <input type="number" step="1" min="0" max="100"
                                name="analytics.predictions.confidenceThresholds.medium" required>
                        </div>
                        <div class="form-group">
                            <label>Low Confidence Threshold (%)</label>
                            <input type="number" step="1" min="0" max="100"
                                name="analytics.predictions.confidenceThresholds.low" required>
                        </div>
                        <div class="form-group">
                            <label>Time to Critical Enabled</label>
                            <select name="analytics.predictions.timeToCriticalEnabled">
                                <option value="true">Enabled</option>
                                <option value="false">Disabled</option>
                            </select>
                        </div>
                    </div>

                    <!-- Patterns -->
                    <div class="subsection">
                        <div class="subsection-title">Pattern Recognition</div>
                        <div class="form-group">
                            <label>Spike Threshold</label>
                            <input type="number" step="0.01" min="0" max="1" name="analytics.patterns.spikeThreshold"
                                required>
                            <span class="input-hint">Percentage change to detect spikes (0-1)</span>
                        </div>
                        <div class="form-group">
                            <label>Acceleration Multiplier</label>
                            <input type="number" step="0.1" min="1" name="analytics.patterns.accelerationMultiplier"
                                required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Display Section -->
            <div class="section collapsed">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">
                        <span class="section-icon">üñ•Ô∏è</span>
                        Display
                    </div>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label>Chart Max Points</label>
                        <input type="number" step="10" min="10" name="display.chartMaxPoints" required>
                        <span class="input-hint">Maximum data points shown on charts</span>
                    </div>
                    <div class="form-group">
                        <label>Chart Time Range (hours)</label>
                        <input type="number" step="1" min="1" name="display.chartTimeRange" required>
                    </div>
                    <div class="form-group">
                        <label>Show Advanced Metrics</label>
                        <select name="display.showAdvancedMetrics">
                            <option value="true">Show</option>
                            <option value="false">Hide</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Temperature Unit</label>
                        <select name="display.temperatureUnit">
                            <option value="celsius">Celsius</option>
                            <option value="fahrenheit">Fahrenheit</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- System Section -->
            <div class="section collapsed">
                <div class="section-header" onclick="toggleSection(this)">
                    <div class="section-title">
                        <span class="section-icon">‚öôÔ∏è</span>
                        System
                    </div>
                    <span class="section-toggle">‚ñº</span>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="text" name="system.apiKey" required>
                        <span class="input-hint">API key for sensor authentication</span>
                    </div>
                    <div class="form-group">
                        <label>Server Port</label>
                        <input type="number" step="1" min="1000" max="65535" name="system.port" required>
                        <span class="input-hint">Requires server restart</span>
                    </div>
                    <div class="form-group">
                        <label>Allow Remote Access</label>
                        <select name="system.allowRemoteAccess">
                            <option value="true">Allowed</option>
                            <option value="false">Blocked</option>
                        </select>
                    </div>
                </div>
            </div>
        </form>

        <div class="action-buttons">
            <button type="button" class="btn btn-danger" onclick="resetToDefaults()">
                üîÑ Reset to Defaults
            </button>
            <button type="button" class="btn btn-secondary" onclick="loadConfig()">
                ‚Üª Reload
            </button>
            <button type="button" class="btn btn-primary" onclick="saveConfig()">
                üíæ Save Changes
            </button>
        </div>
    </div>

    <script>
        let currentConfig = {};
        let syncInterval;
        let hasUnsavedChanges = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            startRealTimeSync();

            // Track changes
            document.getElementById('configForm').addEventListener('input', () => {
                hasUnsavedChanges = true;
            });

            // Warn before leaving with unsaved changes
            window.addEventListener('beforeunload', (e) => {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        });

        // Toggle section collapse
        function toggleSection(header) {
            const section = header.parentElement;
            section.classList.toggle('collapsed');
        }

        // Load configuration from server
        async function loadConfig() {
            try {
                showLoading();
                const response = await fetch('/api/config');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const config = await response.json();
                currentConfig = config;
                populateForm(config);
                hasUnsavedChanges = false;
                showNotification('Configuration loaded successfully', 'success');
                updateLastSynced();
            } catch (error) {
                console.error('Error loading config:', error);
                showNotification('Failed to load configuration: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Populate form with config data
        function populateForm(config) {
            const form = document.getElementById('configForm');
            const inputs = form.querySelectorAll('input, select');

            inputs.forEach(input => {
                const path = input.name.split('.');
                let value = config;

                // Navigate through nested object
                for (const key of path) {
                    if (value && typeof value === 'object' && key in value) {
                        value = value[key];
                    } else {
                        value = undefined;
                        break;
                    }
                }

                if (value !== undefined) {
                    if (input.type === 'checkbox') {
                        input.checked = value === true || value === 'true';
                    } else if (input.tagName === 'SELECT') {
                        input.value = String(value);
                    } else {
                        input.value = value;
                    }
                }
            });
        }

        // Get form data as nested object
        function getFormData() {
            const form = document.getElementById('configForm');
            const inputs = form.querySelectorAll('input, select');
            const data = {};

            inputs.forEach(input => {
                const path = input.name.split('.');
                let current = data;

                // Create nested structure
                for (let i = 0; i < path.length - 1; i++) {
                    if (!current[path[i]]) {
                        current[path[i]] = {};
                    }
                    current = current[path[i]];
                }

                // Set value with proper type conversion
                let value;
                if (input.type === 'number') {
                    value = parseFloat(input.value);
                } else if (input.type === 'checkbox') {
                    value = input.checked;
                } else if (input.tagName === 'SELECT' && (input.value === 'true' || input.value === 'false')) {
                    value = input.value === 'true';
                } else {
                    value = input.value;
                }

                current[path[path.length - 1]] = value;
            });

            return data;
        }

        // Save configuration
        async function saveConfig() {
            try {
                const formData = getFormData();

                // Validate form
                const form = document.getElementById('configForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                showLoading();

                const response = await fetch('/api/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.details ? result.details.join(', ') : result.error || 'Failed to save');
                }

                currentConfig = result.config;
                hasUnsavedChanges = false;
                showNotification('Configuration saved successfully!', 'success');
                updateLastSynced();
            } catch (error) {
                console.error('Error saving config:', error);
                showNotification('Failed to save: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Reset to defaults
        async function resetToDefaults() {
            if (!confirm('Are you sure you want to reset all settings to default values? This cannot be undone.')) {
                return;
            }

            try {
                showLoading();

                const response = await fetch('/api/config/reset', {
                    method: 'POST'
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to reset');
                }

                currentConfig = result.config;
                populateForm(result.config);
                hasUnsavedChanges = false;
                showNotification('Configuration reset to defaults', 'success');
                updateLastSynced();
            } catch (error) {
                console.error('Error resetting config:', error);
                showNotification('Failed to reset: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Real-time sync - check for changes every 5 seconds
        function startRealTimeSync() {
            syncInterval = setInterval(async () => {
                if (hasUnsavedChanges) {
                    return; // Don't sync if user has unsaved changes
                }

                try {
                    const response = await fetch('/api/config');
                    if (!response.ok) return;

                    const serverConfig = await response.json();

                    // Check if config changed
                    if (JSON.stringify(serverConfig) !== JSON.stringify(currentConfig)) {
                        console.log('Configuration changed on server, updating...');
                        currentConfig = serverConfig;
                        highlightChanges(serverConfig);
                        populateForm(serverConfig);
                        showNotification('Configuration updated by another user', 'info');
                        updateLastSynced();
                    } else {
                        updateLastSynced();
                    }
                } catch (error) {
                    console.error('Sync error:', error);
                }
            }, 5000); // Check every 5 seconds
        }

        // Highlight changed fields
        function highlightChanges(newConfig) {
            const form = document.getElementById('configForm');
            const inputs = form.querySelectorAll('input, select');

            inputs.forEach(input => {
                const path = input.name.split('.');
                let oldValue = currentConfig;
                let newValue = newConfig;

                for (const key of path) {
                    oldValue = oldValue?.[key];
                    newValue = newValue?.[key];
                }

                if (oldValue !== newValue) {
                    input.classList.add('changed');
                    setTimeout(() => input.classList.remove('changed'), 500);
                }
            });
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Loading overlay
        function showLoading() {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.id = 'loadingOverlay';
            overlay.innerHTML = '<div class="loading-spinner"></div>';
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Update last synced time
        function updateLastSynced() {
            document.getElementById('lastSynced').textContent = new Date().toLocaleTimeString();
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (syncInterval) {
                clearInterval(syncInterval);
            }
        });
    </script>
</body>

</html>

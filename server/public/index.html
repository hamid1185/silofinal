<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Silo Monitor Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="topbar">
    <div class="topbar-left">
      <h1>Silo Health Monitor</h1>
    </div>
    <div class="topbar-right">
      <span>Last updated: <span id="lastUpdated">-</span></span>
      <button class="refresh-btn" onclick="window.location.href='/settings.html'" style="background: #10b981;">
        ‚öôÔ∏è Settings
      </button>
      <button class="refresh-btn" onclick="window.location.href='/history.html'" style="background: #8b5cf6;">
        History
      </button>
      <button class="refresh-btn" onclick="refreshAll()">
        <span class="spinner" id="refreshSpinner" style="display: none;"></span>
        Refresh
      </button>
    </div>
  </div>

  <div class="container">
    <!-- KPI Cards -->
    <div class="kpi-grid" id="kpiGrid">
      <div class="kpi-card">
        <div class="kpi-label">Active Devices</div>
        <div class="kpi-value"><span id="activeDevicesKpi" class="status-online">0</span></div>
        <div class="kpi-secondary" id="activeDevicesDetail">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Total Readings</div>
        <div class="kpi-value" id="totalReadingsKpi">0</div>
        <div class="kpi-secondary">All time</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Critical Alerts</div>
        <div class="kpi-value"><span id="criticalAlertsKpi" class="status-online">0</span></div>
        <div class="kpi-secondary" id="criticalDetail">No critical alerts</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Avg Health Status</div>
        <div class="kpi-value" id="avgHealthKpi">-</div>
        <div class="kpi-secondary">Across all devices</div>
      </div>
    </div>

    <!-- Connected Devices Grid -->
    <div style="margin-bottom: 24px;">
      <div style="margin-bottom: 16px;">
        <h2 style="font-size: 1.2rem; font-weight: 600; color: #f1f5f9;">Connected Nodes</h2>
      </div>
      <div class="nodes-grid" id="nodesGrid">
        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #64748b;">Loading devices...
        </div>
      </div>
    </div>

    <!-- Predictive Analytics Section -->
    <div style="margin-bottom: 24px;">
      <div style="margin-bottom: 16px;">
        <h2 style="font-size: 1.2rem; font-weight: 600; color: #f1f5f9;">üìà Predictive Analytics</h2>
      </div>
      <div class="analytics-grid" id="analyticsGrid">
        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #64748b;">
          Loading analytics...
        </div>
      </div>
    </div>
  </div>

  <!-- Analytics Modal -->
  <div id="analyticsModal" class="modal">
    <div class="modal-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h3 style="font-size: 1.3rem; font-weight: 600; color: #f1f5f9;" id="modalTitle">Analytics</h3>
        <button onclick="closeAnalytics()"
          style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Close</button>
      </div>
      <div id="modalContent"></div>
    </div>
  </div>

  <div class="timestamp">Updated at <span id="timestamp">-</span></div>

  <script>
    let charts = {};
    let devicesData = {};
    let latestReadings = {};
    let analyticsData = {};
    let refreshInterval;

    async function initDashboard() {
      console.log('Initializing dashboard...');
      await loadData();

      // Set up auto-refresh every 5 seconds
      clearInterval(refreshInterval);
      refreshInterval = setInterval(loadData, 5000);

      // Update timestamp every second
      setInterval(updateTimestamp, 1000);

      updateTimestamp();
    }

    async function loadData() {
      try {
        console.log('Loading data...');
        await Promise.all([
          loadStats(),
          loadDevices(),
          loadLatestReadings()
        ]);

        await renderNodeCards();
        await loadAnalytics();

        console.log('Data loaded successfully');
      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('lastUpdated').textContent = 'Error loading';
        document.getElementById('lastUpdated').style.color = '#ef4444';
      }
    }

    async function refreshAll() {
      try {
        console.log('Manual refresh triggered...');

        // Show loading state
        const refreshBtn = document.querySelector('.refresh-btn');
        const spinner = document.getElementById('refreshSpinner');
        refreshBtn.disabled = true;
        spinner.style.display = 'inline-block';
        document.body.classList.add('loading');

        document.getElementById('lastUpdated').textContent = 'Refreshing...';
        document.getElementById('lastUpdated').style.color = '#f59e0b';

        // Clear existing charts
        Object.values(charts).forEach(chart => chart.destroy());
        charts = {};

        await loadData();

        // Show success feedback
        const lastUpdated = document.getElementById('lastUpdated');
        lastUpdated.textContent = new Date().toLocaleTimeString();
        lastUpdated.style.color = '#10b981';

        setTimeout(() => lastUpdated.style.color = '', 2000);

      } catch (error) {
        console.error('Refresh failed:', error);
        document.getElementById('lastUpdated').textContent = 'Error';
        document.getElementById('lastUpdated').style.color = '#ef4444';
      } finally {
        // Restore button state
        const refreshBtn = document.querySelector('.refresh-btn');
        const spinner = document.getElementById('refreshSpinner');
        refreshBtn.disabled = false;
        spinner.style.display = 'none';
        document.body.classList.remove('loading');
      }
    }

    async function loadStats() {
      try {
        const response = await fetch('/api/stats');
        const stats = await response.json();

        document.getElementById('totalReadingsKpi').textContent =
          (stats.totalReadings?.count || 0).toLocaleString();

        const activeCount = stats.activeDevices?.count || 0;
        document.getElementById('activeDevicesKpi').textContent = activeCount;
        document.getElementById('activeDevicesDetail').textContent =
          `${activeCount} device${activeCount !== 1 ? 's' : ''} online`;

        updateCriticalAlerts();
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    async function loadDevices() {
      try {
        const response = await fetch('/api/devices');
        const devices = await response.json();
        devicesData = devices || [];
        console.log(`Loaded ${devicesData.length} devices`);
      } catch (error) {
        console.error('Error loading devices:', error);
        devicesData = [];
      }
    }

    async function loadLatestReadings() {
      try {
        const response = await fetch('/api/latest');
        const readings = await response.json();

        latestReadings = {};
        (readings || []).forEach(reading => {
          if (reading && reading.deviceId) {
            latestReadings[reading.deviceId] = reading;
          }
        });

        console.log(`Loaded latest readings for ${Object.keys(latestReadings).length} devices`);
        updateCriticalAlerts();
        updateAvgHealth(Object.values(latestReadings));
      } catch (error) {
        console.error('Error loading latest readings:', error);
        latestReadings = {};
      }
    }

    async function loadAnalytics() {
      const analyticsGrid = document.getElementById('analyticsGrid');

      if (devicesData.length === 0 || Object.keys(latestReadings).length === 0) {
        analyticsGrid.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #64748b;">
            No devices online. Connect devices to view analytics.
          </div>
        `;
        return;
      }

      // Clear previous analytics
      analyticsGrid.innerHTML = '';
      analyticsData = {};

      let hasAnalytics = false;
      const analyticsPromises = [];

      // Load analytics for all online devices
      for (const device of devicesData) {
        if (device.status === 'online' && latestReadings[device.deviceId]) {
          analyticsPromises.push(loadDeviceAnalytics(device.deviceId));
        }
      }

      // Wait for all analytics to load
      const results = await Promise.allSettled(analyticsPromises);

      // Process results
      results.forEach((result, index) => {
        if (result.status === 'fulfilled' && result.value) {
          const device = devicesData.find(d => d.status === 'online' && latestReadings[d.deviceId]);
          if (device) {
            hasAnalytics = true;
            renderAnalyticsCard(device.deviceId, result.value);
          }
        }
      });

      if (!hasAnalytics) {
        analyticsGrid.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #64748b;">
            No analytics available. Devices need to send more data for analysis.
          </div>
        `;
      }
    }

    async function loadDeviceAnalytics(deviceId) {
      try {
        console.log(`Loading analytics for ${deviceId}...`);
        const response = await fetch(`/api/trends/${deviceId}?hours=24`);

        if (!response.ok) {
          console.error(`Failed to load analytics for ${deviceId}: ${response.status}`);
          return null;
        }

        const analytics = await response.json();

        // Check if we have sufficient data
        if (analytics.status === "INSUFFICIENT_DATA" || analytics.message?.includes("Need at least")) {
          console.log(`Insufficient data for ${deviceId}`);
          return null;
        }

        analyticsData[deviceId] = analytics;
        return analytics;
      } catch (error) {
        console.error(`Error loading analytics for ${deviceId}:`, error);
        return null;
      }
    }

    function calculateUptime(firstSeen, lastSeen) {
      try {
        const first = new Date(firstSeen);
        const last = new Date(lastSeen);
        const diffHours = Math.floor((last - first) / (1000 * 60 * 60));
        const days = Math.floor(diffHours / 24);
        const hours = diffHours % 24;

        if (days > 0) return `${days}d ${hours}h`;
        return `${hours}h`;
      } catch (e) {
        return '0h';
      }
    }

    async function renderNodeCards() {
      const grid = document.getElementById('nodesGrid');

      if (!devicesData || devicesData.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #64748b;">No devices connected</div>';
        return;
      }

      grid.innerHTML = devicesData.map(device => {
        const reading = latestReadings[device.deviceId];
        const uptime = calculateUptime(device.firstSeen, device.lastSeen);
        const risk = reading?.spoilageRisk || 0;
        const health = reading?.grainHealth || 'UNKNOWN';

        const riskClass = risk > 70 ? 'high' : risk > 40 ? 'medium' : 'low';
        const healthClass = health === 'GOOD' ? 'good' : health === 'WARNING' ? 'warning' : 'critical';
        const statusClass = device.status === 'online' ? 'online' : device.status === 'recent' ? 'recent' : 'disconnected';

        return `
          <div class="node-card" ${device.status === 'offline' ? 'style="opacity: 0.6; border-color: #475569;"' : ''}>
            <div class="node-header">
              <div class="node-title">${device.deviceId || 'Unknown'}</div>
              <div class="node-status ${statusClass}">${(device.status || 'offline').toUpperCase()}</div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; font-size: 0.8rem;">
              <div style="display: flex; align-items: center; gap: 4px;">
                <div style="width: 8px; height: 8px; border-radius: 50%; background: ${device.status === 'online' ? '#10b981' : device.status === 'recent' ? '#f59e0b' : '#64748b'}"></div>
                <span style="color: #94a3b8;">${device.status || 'offline'}</span>
              </div>
              <div style="color: #64748b;">|</div>
              <div style="color: #94a3b8;">Last: ${device.lastSeen ? new Date(device.lastSeen).toLocaleTimeString() : 'Never'}</div>
            </div>
            
            ${reading ? `
              <div class="node-metrics">
                <div class="metric metric-temp">
                  <div class="metric-value">${(reading.temperature || 0).toFixed(1)}¬∞C</div>
                  <div class="metric-label">Temperature</div>
                </div>
                <div class="metric metric-humid">
                  <div class="metric-value">${(reading.humidity || 0).toFixed(1)}%</div>
                  <div class="metric-label">Humidity</div>
                </div>
                <div class="metric metric-dew">
                  <div class="metric-value">${(reading.dewPoint || 0).toFixed(1)}¬∞C</div>
                  <div class="metric-label">Dew Point</div>
                </div>
                <div class="metric metric-abs-humid">
                  <div class="metric-value">${(reading.absoluteHumidity || 0).toFixed(1)} g/m¬≥</div>
                  <div class="metric-label">Abs Humidity</div>
                </div>
                <div class="metric metric-mq">
                  <div class="metric-value">${(reading.mq_value || 0).toFixed(0)}</div>
                  <div class="metric-label">Air Quality</div>
                </div>
                <div class="metric metric-uptime">
                  <div class="metric-value">${uptime}</div>
                  <div class="metric-label">Uptime</div>
                </div>
              </div>
              
              <div class="risk-section">
                <div class="risk-label">
                  <span>Spoilage Risk</span>
                  <span class="risk-value">${(risk || 0).toFixed(1)}%</span>
                </div>
                <div class="risk-indicator">
                  <div class="risk-bar ${riskClass}" style="width: ${Math.min(risk, 100)}%"></div>
                </div>
              </div>
              
              <div class="health-info">
                <div class="health-badge health-${healthClass}">
                  Health: ${health}
                </div>
                <div class="health-badge" style="background: #334155; color: #cbd5e1;">
                  Readings: ${device.readingCount || 0}
                </div>
              </div>
            ` : `
              <div style="padding: 20px; text-align: center; color: #64748b;">No sensor data available</div>
            `}
            
            <div class="node-chart" id="chart-${device.deviceId}">
              <div class="chart-empty">Loading chart...</div>
            </div>
          </div>
        `;
      }).join('');

      // Load charts for all devices
      for (const device of devicesData) {
        if (device.deviceId) {
          await loadDeviceChart(device.deviceId);
        }
      }
    }

    function renderAnalyticsCard(deviceId, analytics) {
      // Get the reading for this device
      const reading = latestReadings[deviceId];
      const device = devicesData.find(d => d.deviceId === deviceId);
      if (!reading || !device) return;

      const predictions = analytics.predictions || {};
      const trends = analytics.trends || {};
      const confidence = analytics.confidence || { level: 'low' };


      const cardHtml = `
        <div class="node-card" id="analytics-${deviceId}">
          <div class="node-header">
            <div class="node-title">üìä ${deviceId} - Predictive Analytics</div>
            <button onclick="showDetailedAnalytics('${deviceId}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">
              View Details
            </button>
          </div>
          
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; font-size: 0.8rem;">
            <div style="display: flex; align-items: center; gap: 4px;">
              <div style="width: 8px; height: 8px; border-radius: 50%; background: ${device.status === 'online' ? '#10b981' : '#64748b'}"></div>
              <span style="color: #94a3b8;">${device.status}</span>
            </div>
            <div style="color: #64748b;">|</div>
            <div style="color: #94a3b8;">Last: ${device.lastSeen ? new Date(device.lastSeen).toLocaleTimeString() : 'Never'}</div>
          </div>
          
          <div style="margin-bottom: 16px;">
            <div style="font-size: 0.9rem; color: #cbd5e1; margin-bottom: 8px;">
              <strong>Summary:</strong> ${analytics.summary?.[0] || 'Analyzing trends...'}
            </div>
          </div>
          
          <div class="node-metrics">
  <div class="metric" style="border-left-color: #f59e0b;" title="${trends.spoilageRisk?.explanation || 'No trend data'}">
    <div class="metric-value">${getTrendIcon(trends.spoilageRisk?.value)} ${(trends.spoilageRisk?.value || 'STABLE').replace('_', ' ')}</div>
    <div class="metric-label">Risk Trend</div>
  </div>
  <div class="metric" style="border-left-color: #10b981;" title="${predictions.reasoning?.join('. ') || 'Based on current trends'}">
    <div class="metric-value">${predictions.predictedRisk || reading.spoilageRisk?.toFixed(1) || '--'}%</div>
    <div class="metric-label">Predicted Risk</div>
  </div>
  <div class="metric" style="border-left-color: #8b5cf6;" title="${predictions.reasoning?.join('. ') || 'Based on current rate of change'}">
    <div class="metric-value">${predictions.timeToCritical ? predictions.timeToCritical + 'h' : 'Stable'}</div>
    <div class="metric-label">Time to Critical</div>
  </div>
  <div class="metric" style="border-left-color: #64748b;" title="${confidence.factors?.join('. ') || 'Based on data quality'}">
    <div class="metric-value" style="text-transform: capitalize;">${confidence.level || 'low'}</div>
    <div class="metric-label">Confidence</div>
  </div>
</div>
          <div style="margin-top: 12px;">
  <div style="font-size: 0.8rem; color: #94a3b8;">
    <strong>Prediction Reasoning:</strong> ${predictions.reasoning?.[0] || 'Monitor conditions...'}
  </div>
  <div style="font-size: 0.7rem; color: #64748b; margin-top: 4px;">
    Confidence factors: ${confidence.factors?.slice(0, 2).join(', ') || 'Limited data'}
  </div>
</div>
          <div style="margin-top: 12px;">
            <div style="font-size: 0.8rem; color: #94a3b8;">
              <strong>Key Recommendation:</strong> ${typeof analytics.recommendations?.[0] === 'object' ? analytics.recommendations[0].message : (analytics.recommendations?.[0] || 'Monitor conditions...')}
            </div>
          </div>
        </div>
      `;

      const analyticsGrid = document.getElementById('analyticsGrid');
      const existingCard = document.getElementById(`analytics-${deviceId}`);

      if (existingCard) {
        existingCard.outerHTML = cardHtml;
      } else {
        analyticsGrid.insertAdjacentHTML('beforeend', cardHtml);
      }
    }

    function getTrendIcon(trend) {
      if (!trend) return 'üìä';

      const trendLower = trend.toLowerCase();
      const icons = {
        'rising_rapidly': 'üö®',
        'rising': 'üìà',
        'falling': 'üìâ',
        'falling_rapidly': 'üíπ',
        'stable': '‚û°Ô∏è'
      };

      return icons[trendLower] || 'üìä';
    }

    async function loadDeviceChart(deviceId) {
      try {
        const response = await fetch(`/api/history/${deviceId}?limit=50&hours=24`);
        const rows = await response.json();

        const chartDiv = document.getElementById(`chart-${deviceId}`);
        if (!chartDiv) return;

        if (!rows || rows.length === 0) {
          chartDiv.innerHTML = '<div class="chart-empty">No historical data</div>';
          return;
        }

        const labels = rows.map(r => {
          const date = r.ts_server ? new Date(r.ts_server) : new Date(r.timestamp);
          return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        });

        const temps = rows.map(r => r.temperature || 0);
        const hums = rows.map(r => r.humidity || 0);
        const risks = rows.map(r => r.spoilageRisk || 0);
        const mqValues = rows.map(r => r.mq_value || 0); // NEW: Add MQ135 values

        chartDiv.innerHTML = '<canvas></canvas>';
        const ctx = chartDiv.querySelector('canvas').getContext('2d');

        if (charts[deviceId]) {
          charts[deviceId].destroy();
        }

        charts[deviceId] = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: 'Temperature ¬∞C',
                data: temps,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.05)',
                fill: true,
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 0,
                pointHoverRadius: 4,
                yAxisID: 'y'
              },
              {
                label: 'Humidity %',
                data: hums,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.05)',
                fill: true,
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 0,
                pointHoverRadius: 4,
                yAxisID: 'y1'
              },
              {
                label: 'MQ135 (Air Quality)',
                data: mqValues, // NEW dataset
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.05)',
                fill: true,
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 0,
                pointHoverRadius: 4,
                yAxisID: 'y2'
              },
              {
                label: 'Spoilage Risk %',
                data: risks,
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.05)',
                fill: true,
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 0,
                pointHoverRadius: 4,
                yAxisID: 'y3'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: {
                display: true,
                labels: { color: '#94a3b8', font: { size: 11 }, usePointStyle: true }
              },
              tooltip: {
                mode: 'index',
                intersect: false,
                backgroundColor: '#1e293b',
                titleColor: '#f1f5f9',
                bodyColor: '#cbd5e1',
                borderColor: '#334155',
                borderWidth: 1,
                callbacks: {
                  label: function (context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.parsed.y !== null) {
                      if (label.includes('Temperature')) {
                        label += context.parsed.y.toFixed(1) + '¬∞C';
                      } else if (label.includes('Humidity')) {
                        label += context.parsed.y.toFixed(1) + '%';
                      } else if (label.includes('MQ135')) {
                        label += context.parsed.y.toFixed(0);
                      } else if (label.includes('Risk')) {
                        label += context.parsed.y.toFixed(1) + '%';
                      }
                    }
                    return label;
                  }
                }
              }
            },
            scales: {
              x: {
                display: true,
                grid: { color: '#334155', drawBorder: false },
                ticks: { color: '#94a3b8', maxRotation: 0, font: { size: 9 } }
              },
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                grid: { color: '#334155', drawBorder: false },
                ticks: { color: '#ef4444', font: { size: 9 } },
                title: {
                  display: true,
                  text: 'Temperature (¬∞C)',
                  color: '#ef4444',
                  font: { size: 10 }
                }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                grid: { drawOnChartArea: false, drawBorder: false },
                ticks: { color: '#3b82f6', font: { size: 9 } },
                title: {
                  display: true,
                  text: 'Humidity (%)',
                  color: '#3b82f6',
                  font: { size: 10 }
                }
              },
              y2: {
                type: 'linear',
                display: true,
                position: 'right',
                offset: true,
                grid: { drawOnChartArea: false, drawBorder: false },
                ticks: { color: '#8b5cf6', font: { size: 9 } },
                title: {
                  display: true,
                  text: 'MQ135',
                  color: '#8b5cf6',
                  font: { size: 10 }
                }
              },
              y3: {
                type: 'linear',
                display: false
              }
            }
          }
        });

      } catch (error) {
        console.error(`Error loading chart for ${deviceId}:`, error);
        const chartDiv = document.getElementById(`chart-${deviceId}`);
        if (chartDiv) {
          chartDiv.innerHTML = '<div class="chart-empty">Chart error</div>';
        }
      }
    }

    function showDetailedAnalytics(deviceId) {
      const analytics = analyticsData[deviceId];
      const device = devicesData.find(d => d.deviceId === deviceId);
      const reading = latestReadings[deviceId];

      if (!analytics || !device || !reading) {
        alert('No analytics data available for this device');
        return;
      }

      const modal = document.getElementById('analyticsModal');
      const title = document.getElementById('modalTitle');
      const content = document.getElementById('modalContent');

      title.textContent = `üìà Detailed Analytics - ${deviceId}`;

      const predictions = analytics.predictions || {};
      const trends = analytics.trends || {};
      const patterns = analytics.patterns || {};

      content.innerHTML = `
        <div style="display: grid; gap: 20px;">
          <!-- Current Status -->
          <div style="background: #0f172a; padding: 16px; border-radius: 8px;">
            <h4 style="color: #f1f5f9; margin-bottom: 12px;">Current Status</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
              <div style="text-align: center; padding: 12px; background: #1e293b; border-radius: 6px;">
                <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 4px;">Temperature</div>
                <div style="font-size: 1.2rem; font-weight: bold; color: #ef4444;">${reading.temperature?.toFixed(1) || '--'}¬∞C</div>
              </div>
              <div style="text-align: center; padding: 12px; background: #1e293b; border-radius: 6px;">
                <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 4px;">Humidity</div>
                <div style="font-size: 1.2rem; font-weight: bold; color: #3b82f6;">${reading.humidity?.toFixed(1) || '--'}%</div>
              </div>
              <div style="text-align: center; padding: 12px; background: #1e293b; border-radius: 6px;">
                <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 4px;">Risk Level</div>
                <div style="font-size: 1.2rem; font-weight: bold; color: ${reading.spoilageRisk > 70 ? '#ef4444' : reading.spoilageRisk > 40 ? '#f59e0b' : '#10b981'}">
                  ${reading.spoilageRisk?.toFixed(1) || '--'}%
                </div>
              </div>
              <div style="text-align: center; padding: 12px; background: #1e293b; border-radius: 6px;">
                <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 4px;">Health</div>
                <div style="font-size: 1.2rem; font-weight: bold; color: ${reading.grainHealth === 'CRITICAL' ? '#ef4444' : reading.grainHealth === 'WARNING' ? '#f59e0b' : '#10b981'}">
                  ${reading.grainHealth || '--'}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Summary Section -->
          <div style="background: #0f172a; padding: 16px; border-radius: 8px;">
            <h4 style="color: #f1f5f9; margin-bottom: 12px;">Executive Summary</h4>
            ${analytics.summary?.map(s => `
              <div style="color: #cbd5e1; margin-bottom: 8px; padding: 12px; background: #1e293b; border-radius: 6px; border-left: 4px solid #f59e0b;">
                ${s}
              </div>
            `).join('') || '<div style="color: #64748b; text-align: center; padding: 20px;">No summary available</div>'}
          </div>
          
          <!-- Predictions Section -->
          <div style="background: #0f172a; padding: 16px; border-radius: 8px;">
            <h4 style="color: #f1f5f9; margin-bottom: 12px;">Predictive Analysis</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
              <div style="text-align: center; padding: 16px; background: #1e293b; border-radius: 8px; border: 1px solid #334155;">
                <div style="font-size: 1.8rem; font-weight: bold; color: #f59e0b; margin-bottom: 8px;">${predictions.predictedRisk || reading.spoilageRisk?.toFixed(1) || '--'}%</div>
                <div style="font-size: 0.8rem; color: #94a3b8; text-transform: uppercase;">Predicted Risk</div>
              </div>
              <div style="text-align: center; padding: 16px; background: #1e293b; border-radius: 8px; border: 1px solid #334155;">
                <div style="font-size: 1.8rem; font-weight: bold; color: ${predictions.timeToCritical ? '#ef4444' : '#10b981'}; margin-bottom: 8px;">
                  ${predictions.timeToCritical ? predictions.timeToCritical + 'h' : 'Stable'}
                </div>
                <div style="font-size: 0.8rem; color: #94a3b8; text-transform: uppercase;">Time to Critical</div>
              </div>
              <div style="text-align: center; padding: 16px; background: #1e293b; border-radius: 8px; border: 1px solid #334155;">
                <div style="font-size: 1.8rem; font-weight: bold; color: #8b5cf6; margin-bottom: 8px; text-transform: capitalize;">${predictions.confidence || 'low'}</div>
                <div style="font-size: 0.8rem; color: #94a3b8; text-transform: uppercase;">Confidence Level</div>
              </div>
            </div>
          </div>
          
          <!-- Trends Section -->
          <div style="background: #0f172a; padding: 16px; border-radius: 8px;">
            <h4 style="color: #f1f5f9; margin-bottom: 12px;">Trend Analysis</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
              ${Object.entries(trends).map(([key, value]) => {
        const valueStr = value?.value ? String(value.value).replace('_', ' ') : (String(value || 'N/A').replace('_', ' '));
        return `
                <div style="text-align: center; padding: 16px; background: #1e293b; border-radius: 8px; border: 1px solid #334155;">
                  <div style="font-size: 2rem; margin-bottom: 8px;">${getTrendIcon(value?.value || value)}</div>
                  <div style="font-size: 0.9rem; color: #f1f5f9; text-transform: capitalize; margin-bottom: 4px;">${key.replace(/([A-Z])/g, ' $1')}</div>
                  <div style="font-size: 0.8rem; color: #94a3b8; text-transform: capitalize;">${valueStr}</div>
                </div>
              `;
      }).join('')}
            </div>
          </div>
          
          <!-- Recommendations Section -->
          <div style="background: #0f172a; padding: 16px; border-radius: 8px;">
            <h4 style="color: #f1f5f9; margin-bottom: 12px;">Actionable Recommendations</h4>
            ${(analytics.recommendations && analytics.recommendations.length > 0) ? analytics.recommendations.map((rec, index) => {
        const isObject = typeof rec === 'object';
        const priority = isObject ? rec.priority : 'LOW';
        const message = isObject ? rec.message : rec;
        const action = isObject ? rec.action : '';
        const priorityColors = {
          'CRITICAL': '#ef4444',
          'HIGH': '#f59e0b',
          'MEDIUM': '#3b82f6',
          'LOW': '#10b981'
        };
        return `
              <div style="display: flex; align-items: start; gap: 12px; margin-bottom: 12px; padding: 16px; background: #1e293b; border-radius: 8px; border-left: 4px solid ${priorityColors[priority] || '#3b82f6'};">
                <div style="font-size: 1.2rem; color: ${priorityColors[priority] || '#3b82f6'}; min-width: 24px;">${index + 1}.</div>
                <div style="flex: 1;">
                  ${isObject ? `<div style="display: inline-block; padding: 2px 8px; background: ${priorityColors[priority]}22; color: ${priorityColors[priority]}; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-bottom: 8px;">${priority}</div>` : ''}
                  <div style="color: #cbd5e1; font-size: 0.9rem; margin-bottom: 4px;">${message}</div>
                  ${action ? `<div style="color: #94a3b8; font-size: 0.8rem; font-style: italic;">‚Üí ${action}</div>` : ''}
                </div>
              </div>
            `;
      }).join('') : '<div style="color: #64748b; text-align: center; padding: 20px;">No specific recommendations at this time</div>'}
          </div>
          
          <!-- Patterns Section -->
          <div style="background: #0f172a; padding: 16px; border-radius: 8px;">
            <h4 style="color: #f1f5f9; margin-bottom: 12px;">Detected Patterns</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
              ${(patterns && Object.keys(patterns).length > 0) ? Object.entries(patterns).map(([pattern, detected]) => `
                <div style="text-align: center; padding: 16px; background: #1e293b; border-radius: 8px; border: 2px solid ${detected ? '#ef4444' : '#334155'};">
                  <div style="font-size: 1.5rem; margin-bottom: 8px;">${detected ? 'üö®' : '‚úÖ'}</div>
                  <div style="font-size: 0.9rem; color: ${detected ? '#ef4444' : '#94a3b8'}; text-transform: capitalize; margin-bottom: 4px;">
                    ${pattern.replace(/([A-Z])/g, ' $1')}
                  </div>
                  <div style="font-size: 0.8rem; color: #64748b; text-transform: uppercase;">
                    ${detected ? 'Detected' : 'Not detected'}
                  </div>
                </div>
              `).join('') : '<div style="color: #64748b; text-align: center; padding: 20px; grid-column: 1/-1;">No pattern data available</div>'}
            </div>
          </div>
        </div>
      `;

      modal.style.display = 'block';
    }

    function closeAnalytics() {
      document.getElementById('analyticsModal').style.display = 'none';
    }

    function updateCriticalAlerts() {
      const readings = Object.values(latestReadings);
      const critical = readings.filter(r => {
        const risk = r.spoilageRisk || 0;
        const health = r.grainHealth || '';
        return risk > 70 || health === 'CRITICAL';
      }).length;

      const kpi = document.getElementById('criticalAlertsKpi');
      const detail = document.getElementById('criticalDetail');

      kpi.textContent = critical;
      kpi.className = critical > 0 ? 'status-warning' : 'status-online';
      detail.textContent = critical > 0 ? `${critical} device${critical !== 1 ? 's' : ''} critical` : 'All systems normal';
    }

    function updateAvgHealth(readings) {
      if (!readings || readings.length === 0) {
        document.getElementById('avgHealthKpi').textContent = '-';
        return;
      }

      const validReadings = readings.filter(r => r && r.spoilageRisk != null);
      if (validReadings.length === 0) {
        document.getElementById('avgHealthKpi').textContent = '-';
        return;
      }

      const avgRisk = validReadings.reduce((sum, r) => sum + (r.spoilageRisk || 0), 0) / validReadings.length || 0;
      const status = avgRisk > 70 ? 'Critical' : avgRisk > 40 ? 'Warning' : 'Good';

      document.getElementById('avgHealthKpi').textContent = status;
    }

    function updateTimestamp() {
      const now = new Date();
      document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
      document.getElementById('timestamp').textContent = now.toLocaleString();
    }

    // Initialize dashboard when page loads
    document.addEventListener('DOMContentLoaded', initDashboard);

    // Close modal when clicking outside
    window.addEventListener('click', (event) => {
      const modal = document.getElementById('analyticsModal');
      if (event.target === modal) {
        closeAnalytics();
      }
    });
  </script>
</body>

</html>